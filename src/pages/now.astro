---
import Base from "@layouts/Base.astro";
import Link from "@components/Link.astro";

import Parser from 'rss-parser';
const GOODREADS_ID = '197032067';
const CURRENTLY_READING_URL = `https://www.goodreads.com/review/list_rss/${GOODREADS_ID}?shelf=currently-reading`;
const RECENT_READS_URL = `https://www.goodreads.com/review/list_rss/${GOODREADS_ID}?shelf=read`;

const parser = new Parser({
  customFields: {
    item: [
      ['book_published', 'year'],
      ['author_name', 'author'],
      ['user_rating', 'rating']
    ],
  }
});

let currentlyReading = null;
let recentReads = null;

try {
  const [readingFeed, readFeed] = await Promise.all([
    parser.parseURL(CURRENTLY_READING_URL),
    parser.parseURL(RECENT_READS_URL)
  ]);

  // Helper to extract the first book link from content HTML
  const getBookLink = (item) => {
    const match = item.content.match(/href="([^"]+)"/);
    const url = match ? match[1] : item.link;
    return url.split('?')[0];
  };

  readingFeed?.items.forEach((item) => item.link = getBookLink(item));
  readFeed?.items.forEach((item) => item.link = getBookLink(item));

  currentlyReading = readingFeed?.items;
  recentReads = readFeed?.items.slice(0, 3);

} catch (e) {console.log(`failed getting goodreads: ${e}`)}

const renderStars = (n) => "★".repeat(n) + "☆".repeat(5 - n);
---

<Base
  pageTitle="now"
  description="A page about what I'm currently up to in life."
>
  <article class="animate">
      <h1 id="title-now">now::</h1>
      <p>Going on a holiday. Detoxing from the internet and the world at large. Reading more to
      replace various unhealthy brainworms.</p>

      <p>Time elapsed since I've last used a content recommendation algorithm: <span id="algo-timer">..</span>.</p>

      <h2>programming::</h2>
      <p>Trying to make copying and pasting easier for people who use many terminal panes, including
      some that may be accessing an <code>ssh</code> connection.</p>
      <Link href="https://github.com/rozukke/lazycp">Check out lazycp! (WIP)</Link>

      <div class="read-list">
      <h2>reading::</h2>
      <ul>
      {currentlyReading ?
          (currentlyReading.length != 0 ?
            currentlyReading?.map((book) => (
            <li><Link href={book.link}><strong>{book.title.split(':')[0]}</strong></Link> by {book.author} ({book.year})</li>))
            : <p>Nothing much, looks like.</p>)
      : <p>Looks like the Goodreads RSS API broke. Oops!</p>
      }
      </ul>
      <h2>recently read::</h2>
      <ul>
      {recentReads ?
          (recentReads.length != 0 ?
            recentReads?.map((book) => (
            <li><Link href={book.link}><strong>{book.title.split(':')[0]}</strong></Link> by {book.author} ({book.year}) 「{renderStars(book.rating)}」</li>))
            : <p>Nothing much, looks like.</p>)
      : <p>Looks like the Goodreads RSS API broke. Oops!</p>
      }
      </ul>
      </div>
  </article>
</Base>

<script>
  function initTimer() {
    const display = document.getElementById('algo-timer');
    if (!display) return;

    const s = (num) => num == 1 ? "" : "s";
    const start = new Date("2025-11-13T20:33:45").getTime();

    function update() {
      const now = new Date().getTime();
      const diff = now - start;

      const m = Math.floor((diff / (1000 * 60)) % 60);
      const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
      const d = Math.floor(diff / (1000 * 60 * 60 * 24));

      display.textContent = `${d} day${s(d)}, ${h} hour${s(h)}, ${m} minute${s(m)}`;
    }

    setInterval(update, 60000);
    update();
  }

  initTimer();
</script>

<style>
  #title-now::after {
    content: "february 2nd 2026";
    display: block;
    margin-top: -0.9em;
    margin-bottom: 1em;
    color: var(--uhl-color);
    font-size: 0.5em;
  }

  .read-list ul {
    padding-left: 0.5em;
  }
  .read-list li {
    position: relative;
    list-style-type: none;
    margin-bottom: 0.7em;
    line-height: 1.5em;
  }

  .read-list li::before {
      content: "~>";
      position: absolute;
      left: -1.5em;
      font-family: var(--mono-font);
      color: var(--hero-color);
  }

</style>
